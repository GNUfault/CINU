.intel_syntax noprefix

.section .data
cursor_x: .long 0
cursor_y: .long 0

.section .rodata
font8x16:
.byte 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x18,0x3C,0x3C,0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00
.byte 0x6C,0x6C,0x6C,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x6C,0x6C,0xFE,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x0C,0x18,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.byte 0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.rept 79
.byte 0x00,0x7E,0x81,0xA5,0x81,0xBD,0x99,0x81,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.endr

.section .text
.global printk

printk:
    push ebp
    mov ebp, esp

    mov esi, [ebp+8]
    mov edi, [0x5000]

.next:
    lodsb
    test al, al
    jz .done

    cmp al, 10
    je .newline

    cmp al, 32
    jb .next
    cmp al, 126
    ja .next

    sub al, 32
    movzx eax, al
    shl eax, 4
    lea edx, [font8x16 + eax]

    mov eax, [cursor_y]
    imul eax, 16
    imul eax, 1024
    imul eax, 3

    mov ecx, [cursor_x]
    imul ecx, 8
    imul ecx, 3
    add eax, ecx
    add eax, edi

    mov ecx, 16

.row:
    push ecx
    mov bl, [edx]
    mov ecx, 8

.col:
    test bl, 0x80
    jz .skip
    mov byte ptr [eax], 0xC0
    mov byte ptr [eax+1], 0xC0
    mov byte ptr [eax+2], 0xC0
.skip:
    shl bl, 1
    add eax, 3
    loop .col

    sub eax, 24
    add eax, 3072
    inc edx
    pop ecx
    loop .row

    inc dword ptr [cursor_x]
    cmp dword ptr [cursor_x], 128
    jb .next

.newline:
    mov dword ptr [cursor_x], 0
    inc dword ptr [cursor_y]
    jmp .next

.done:
    mov esp, ebp
    pop ebp
    ret
